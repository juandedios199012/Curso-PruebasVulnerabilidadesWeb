
package cleanTest;

import commons.JsonUtil;
import factoryRequest.FactoryRequest;
import factoryRequest.RequestInformation;
import factoryRequest.ResponseInformation;
import io.qameta.allure.*;
import io.qameta.allure.junit4.DisplayName;
import org.junit.After;
import org.junit.Test;

import static commons.Configurations.hostUT;
import static commons.OwaspAPI.*;

public class VulnerabilityTest {

    String idScanner;

    @Test
    @DisplayName("Verify launch the vulnerability Scan using OWASP")
    @Description("This test case is to verify all the vulnerability attacks")
    @Link("www.jira.com/TC245698")
    @Issue("BUG00001")
    @Severity(SeverityLevel.BLOCKER)
    public void startVulnerabilityAttackOwasp() throws InterruptedException {
        idScanner=this.startScannerOWASP();
        this.monitoringTheAttackPercentage(idScanner);

    }

    @Step("Start Scan Attack Using OWASP ZAP")
    public String startScannerOWASP(){
        RequestInformation requestInformation= new RequestInformation();
        requestInformation.setUrl(owaspHost+String.format(START_SCAN_OWASP,hostUT));
        ResponseInformation response=FactoryRequest.make(FactoryRequest.GET).send(requestInformation);
        String idScanner= JsonUtil.getAttribute(response.getBody(),SCAN_PROPERTY);
        return idScanner;
    }

    @Step("Monitoring the OWASP ZAP Attack while it is completed 100%")
    public void monitoringTheAttackPercentage(String idScanner ) throws InterruptedException {
        String  percentage= "0";
        RequestInformation requestInformation= new RequestInformation();
        ResponseInformation response= new ResponseInformation();
        while(!percentage.equals("100")){
            Thread.sleep(15000);

            requestInformation.setUrl(owaspHost+String.format(GET_STATUS_SCAN,idScanner));
            response=FactoryRequest.make(FactoryRequest.GET).send(requestInformation);
            percentage= JsonUtil.getAttribute(response.getBody(),STATUS_PERCENTAGE);
            System.out.println("* Percentage Status: "+percentage+"%");

            requestInformation.setUrl(owaspHost+String.format(GET_ALERTS,hostUT));
            response=FactoryRequest.make(FactoryRequest.GET).send(requestInformation);
            System.out.println(response.getBody());
        }

        System.out.println("100% Scaneo Terminado");
    }

    @After
    public void generateReport(){
        RequestInformation requestInformation= new RequestInformation();
        ResponseInformation response= new ResponseInformation();
        requestInformation.setUrl(owaspHost+String.format(GET_SCAN_PROGRESS,idScanner));
        response= FactoryRequest.make(FactoryRequest.GET).send(requestInformation);
        this.attachHTML("OWASP type Attack Progress",response.getBody());
        requestInformation.setUrl(owaspHost+GENERATE_REPORT_HTML);
        response= FactoryRequest.make(FactoryRequest.GET).send(requestInformation);
        this.attachHTML("OWASP Detail Report Alert",response.getBody());

    }

    @Attachment(value="{0}",type="text/html")
    public String attachHTML(String name,String htmlReport){
        return htmlReport;
    }

}